---
/**
 * ─── Blog Search Component ───
 * Búsqueda instantánea del blog usando Pagefind.
 */
---

<div class="blog-search">
  <div class="blog-search__input-wrap">
    <svg class="blog-search__icon" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5">
      <circle cx="11" cy="11" r="8"/>
      <path d="m21 21-4.35-4.35"/>
    </svg>
    <input
      type="search"
      id="blog-search-input"
      class="blog-search__input"
      placeholder="Buscar artículos..."
      autocomplete="off"
    />
    <kbd class="blog-search__kbd">⌘K</kbd>
  </div>
  <div id="blog-search-results" class="blog-search__results"></div>
</div>

<script is:inline>
  // Inicializar Pagefind cuando el DOM esté listo
  (async function initPagefind() {
    const input = document.getElementById('blog-search-input');
    const resultsContainer = document.getElementById('blog-search-results');

    if (!input || !resultsContainer) return;

    // Cargar Pagefind dinámicamente (solo disponible después del build)
    let pagefind;

    try {
      pagefind = await import('/pagefind/pagefind.js');
      await pagefind.init();
    } catch (e) {
      // Pagefind no disponible en dev mode - mostrar mensaje
      input.placeholder = 'Búsqueda disponible en producción';
      return;
    }

    // Debounce para búsqueda
    let timeout;

    input.addEventListener('input', async () => {
      clearTimeout(timeout);
      const query = input.value.trim();

      if (query.length < 2) {
        resultsContainer.innerHTML = '';
        resultsContainer.classList.remove('active');
        return;
      }

      timeout = setTimeout(async () => {
        const search = await pagefind.search(query);
        const results = await Promise.all(
          search.results.slice(0, 5).map((r) => r.data())
        );

        if (results.length === 0) {
          resultsContainer.innerHTML = `
            <div class="blog-search__no-results">
              No se encontraron resultados para "${query}"
            </div>
          `;
        } else {
          resultsContainer.innerHTML = results.map((result) => `
            <a href="${result.url}" class="blog-search__result">
              <span class="blog-search__result-title">${result.meta.title || 'Sin título'}</span>
              <span class="blog-search__result-excerpt">${result.excerpt}</span>
            </a>
          `).join('');
        }

        resultsContainer.classList.add('active');
      }, 200);
    });

    // Cerrar resultados al hacer clic fuera
    document.addEventListener('click', (e) => {
      if (!input.contains(e.target) && !resultsContainer.contains(e.target)) {
        resultsContainer.classList.remove('active');
      }
    });

    // Atajo de teclado Cmd+K / Ctrl+K
    document.addEventListener('keydown', (e) => {
      if ((e.metaKey || e.ctrlKey) && e.key === 'k') {
        e.preventDefault();
        input.focus();
      }
      if (e.key === 'Escape') {
        resultsContainer.classList.remove('active');
        input.blur();
      }
    });
  })();
</script>

<style>
  .blog-search {
    position: relative;
    width: 100%;
  }

  .blog-search__input-wrap {
    position: relative;
    display: flex;
    align-items: center;
  }

  .blog-search__icon {
    position: absolute;
    left: var(--space-3);
    color: var(--color-smoke-400);
    pointer-events: none;
  }

  .blog-search__input {
    width: 100%;
    padding: var(--space-3) var(--space-4) var(--space-3) var(--space-10);
    font-size: var(--text-sm);
    font-family: inherit;
    color: var(--color-smoke-800);
    background: white;
    border: 1px solid var(--color-smoke-200);
    border-radius: var(--radius-lg);
    outline: none;
    transition: all 0.2s ease;
  }

  .blog-search__input:focus {
    border-color: var(--color-fire-400);
    box-shadow: 0 0 0 3px rgba(220, 38, 38, 0.1);
  }

  .blog-search__input::placeholder {
    color: var(--color-smoke-400);
  }

  .blog-search__kbd {
    position: absolute;
    right: var(--space-3);
    padding: 2px 6px;
    font-size: 10px;
    font-family: inherit;
    color: var(--color-smoke-400);
    background: var(--color-smoke-100);
    border: 1px solid var(--color-smoke-200);
    border-radius: var(--radius-sm);
  }

  .blog-search__results {
    position: absolute;
    top: 100%;
    left: 0;
    right: 0;
    background: white;
    border: 1px solid var(--color-smoke-200);
    border-radius: var(--radius-lg);
    box-shadow: 0 10px 40px rgba(0, 0, 0, 0.15);
    margin-top: var(--space-2);
    max-height: 400px;
    overflow-y: auto;
    z-index: 100;
    display: none;
  }

  .blog-search__results.active {
    display: block;
  }

  .blog-search__result {
    display: block;
    padding: var(--space-4);
    text-decoration: none;
    border-bottom: 1px solid var(--color-smoke-100);
    transition: background 0.15s ease;
  }

  .blog-search__result:last-child {
    border-bottom: none;
  }

  .blog-search__result:hover {
    background: var(--color-fire-50);
  }

  .blog-search__result-title {
    display: block;
    font-size: var(--text-sm);
    font-weight: 700;
    color: var(--color-smoke-900);
    margin-bottom: var(--space-1);
  }

  .blog-search__result-excerpt {
    display: block;
    font-size: var(--text-xs);
    color: var(--color-smoke-600);
    line-height: 1.5;
  }

  .blog-search__result-excerpt mark {
    background: var(--color-fire-100);
    color: var(--color-fire-700);
    padding: 0 2px;
    border-radius: 2px;
  }

  .blog-search__no-results {
    padding: var(--space-6);
    text-align: center;
    font-size: var(--text-sm);
    color: var(--color-smoke-500);
  }
</style>
